<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Injini | MEL Dashboard</title>
    <meta name="description"
        content="Injini MEL Dashboard — Real-time monitoring of EdTech venture performance across all cohorts.">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: {
                        injiniBlue: '#001c94',
                        injiniGold: '#ffd100',
                        injiniGreen: '#008a40',
                        injiniRed: '#ff585f'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 font-sans text-slate-800">
    <div class="flex h-screen overflow-hidden">

        <!-- SIDEBAR -->
        <aside class="w-64 bg-injiniBlue text-white flex flex-col shadow-xl z-10">
            <div class="p-6 pb-4">
                <img src="/static/logo.svg" alt="Injini Logo" class="h-10">
            </div>
            <nav class="flex-1 px-4 py-2 space-y-1">
                {% for tab in ['Cohort 1', 'Cohort 2', 'Cohort 3', 'Cohort 4', 'Overall'] %}
                <button data-tab="{{ tab }}" onclick="switchTab('{{ tab }}')"
                    class="sidebar-link w-full text-left block px-4 py-3 rounded-lg text-sm font-medium transition
                    {% if loop.first %}bg-blue-800/50 border-l-4 border-injiniGold text-white{% else %}text-blue-100 hover:bg-blue-800/50{% endif %}">
                    {{ tab }}
                </button>
                {% endfor %}
            </nav>
            <div class="p-4 border-t border-blue-800/50">
                <p class="text-[10px] text-blue-300 uppercase tracking-widest">Powered by Injini MEL</p>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="flex-1 overflow-y-auto p-8">

            <!-- ====== COHORT TABS (1–4) ====== -->
            {% for cohort_key in ['Cohort 1', 'Cohort 2', 'Cohort 3', 'Cohort 4'] %}
            {% set cnum = loop.index %}
            {% set cd = cohort_detail.get(cohort_key, {}) %}
            <div id="tab-{{ cohort_key }}" class="tab-panel" {% if not loop.first %}style="display:none" {% endif %}>

                <!-- Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-900">{{ cohort_key }}</h2>
                    <p class="text-slate-500 mt-1">Performance dashboard for {{ cohort_key }} fellows</p>
                </div>

                <!-- ── BUSINESS HEALTH ── -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-injiniBlue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        Business Health
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Sales Growth</h4>
                            <div id="sales-c{{ cnum }}" style="min-height: 320px;"></div>
                        </div>
                        <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Profit Growth
                            </h4>
                            <div id="profit-c{{ cnum }}" style="min-height: 320px;"></div>
                        </div>
                    </div>
                    <!-- Growth % Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden mt-6">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th
                                            class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Fellow Name</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Sales Growth %</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Profit Growth %</th>
                                        <th
                                            class="px-6 py-4 text-center font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Red Flags</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for g in cd.get('growth_table', []) %}
                                    <tr
                                        class="hover:bg-slate-50/50 transition {% if g.red_flags %}bg-red-50/30{% endif %}">
                                        <td class="px-6 py-4 font-semibold text-slate-900">{{ g.name }}</td>
                                        <td class="px-6 py-4 text-right font-mono font-semibold
                                            {% if g.sales_growth == 'Insufficient Data' %}text-slate-400
                                            {% elif g.sales_growth is number and g.sales_growth < 0 %}text-injiniRed
                                            {% else %}text-injiniGreen{% endif %}">
                                            {% if g.sales_growth == 'Insufficient Data' %}N/A{% else %}{{ g.sales_growth
                                            }}%{% endif %}
                                        </td>
                                        <td class="px-6 py-4 text-right font-mono font-semibold
                                            {% if g.profit_growth == 'Insufficient Data' %}text-slate-400
                                            {% elif g.profit_growth is number and g.profit_growth < 0 %}text-injiniRed
                                            {% else %}text-injiniGreen{% endif %}">
                                            {% if g.profit_growth == 'Insufficient Data' %}N/A{% else %}{{
                                            g.profit_growth }}%{% endif %}
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            {% if g.red_flags %}
                                            <div class="flex flex-wrap gap-1 justify-center">
                                                {% for flag in g.red_flags %}
                                                <span
                                                    class="text-[10px] font-bold px-2 py-1 bg-red-100 text-injiniRed rounded-full">{{
                                                    flag }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <span class="text-[10px] text-slate-300">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not cd.get('growth_table') %}
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">No growth
                                            data available</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ── JOBS ── -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-injiniGreen" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z">
                            </path>
                        </svg>
                        Jobs
                    </h3>
                    <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm mb-6">
                        <div id="jobs-c{{ cnum }}" style="min-height: 320px;"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th
                                            class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Fellow Name</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Total Jobs</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            New Jobs Created</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            % Change</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            New Female Jobs</th>
                                        <th
                                            class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                            Youth Jobs</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for j in cd.get('jobs_table', []) %}
                                    <tr class="hover:bg-slate-50/50 transition">
                                        <td class="px-6 py-4 font-semibold text-slate-900">{{ j.name }}</td>
                                        <td class="px-6 py-4 text-right font-mono font-semibold text-slate-800">{{
                                            "{:,}".format(j.total) }}</td>
                                        <td
                                            class="px-6 py-4 text-right font-mono font-semibold {% if j.new >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %}">
                                            {{ "{:+,}".format(j.new) }}</td>
                                        <td
                                            class="px-6 py-4 text-right font-mono font-semibold {% if j.pct_change >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %}">
                                            {{ j.pct_change }}%</td>
                                        <td class="px-6 py-4 text-right font-mono font-semibold text-injiniBlue">{{
                                            "{:+,}".format(j.new_female) }}</td>
                                        <td class="px-6 py-4 text-right font-mono font-semibold text-slate-800">{{
                                            "{:,}".format(j.youth) }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% if not cd.get('jobs_table') %}
                                    <tr>
                                        <td colspan="6" class="px-6 py-8 text-center text-slate-400 italic">No jobs data
                                            available for this cohort</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ── INVESTMENTS ── -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-injiniGold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Investments
                    </h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <!-- Collapsible toggle bar -->
                        <button
                            onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.inv-arrow').classList.toggle('rotate-180')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-slate-50 hover:bg-slate-100 transition cursor-pointer border-b border-slate-200">
                            <span class="text-sm font-semibold text-slate-600">
                                {{ cd.get('investments_table', [])|length }} investment record{{ 's' if
                                cd.get('investments_table', [])|length != 1 }}
                                {% set inv_total = cd.get('investments_table', []) | map(attribute='value') | sum %}
                                — Total: <span class="text-injiniGreen font-mono">R {{ "{:,.0f}".format(inv_total)
                                    }}</span>
                            </span>
                            <svg class="inv-arrow w-5 h-5 text-slate-400 transition-transform duration-200" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Table (hidden by default) -->
                        <div class="hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-slate-50 border-b border-slate-200">
                                            <th
                                                class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Fellow Name</th>
                                            <th
                                                class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Rand Value</th>
                                            <th
                                                class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Investor Name</th>
                                            <th
                                                class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Month</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        {% for inv in cd.get('investments_table', []) %}
                                        <tr class="hover:bg-slate-50/50 transition">
                                            <td class="px-6 py-4 font-semibold text-slate-900">{{ inv.name }}</td>
                                            <td class="px-6 py-4 text-right font-mono font-semibold text-injiniGreen">R
                                                {{ "{:,.0f}".format(inv.value) }}</td>
                                            <td class="px-6 py-4 text-slate-700">{{ inv.investor }}</td>
                                            <td class="px-6 py-4 text-slate-500">{{ inv.month }}</td>
                                        </tr>
                                        {% endfor %}
                                        {% if not cd.get('investments_table') %}
                                        <tr>
                                            <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">No
                                                investment data available for this cohort</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ── SOLUTIONS REACHED ── -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-injiniBlue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                            </path>
                        </svg>
                        Solutions Reached
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Total Subscribers
                            </h4>
                            <p class="text-xs text-slate-400 mb-3">Learners &amp; Educators by month</p>
                            <div id="subs-c{{ cnum }}" style="min-height: 300px;"></div>
                        </div>
                        <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">New Subscribers
                                (Cumulative)</h4>
                            <p class="text-xs text-slate-400 mb-3">Cumulative month-on-month</p>
                            <div id="newsubs-c{{ cnum }}" style="min-height: 300px;"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Total Schools &amp;
                            Learning Institutions</h4>
                        <div id="schools-c{{ cnum }}" style="min-height: 300px;"></div>
                    </div>
                </div>

                <!-- ── LEARNER DISAGGREGATION ── -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Learner Disaggregation
                    </h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <!-- Collapsible toggle bar -->
                        <button
                            onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.disagg-arrow').classList.toggle('rotate-180')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-slate-50 hover:bg-slate-100 transition cursor-pointer border-b border-slate-200">
                            <span class="text-sm font-semibold text-slate-600">
                                {{ cd.get('disaggregation', [])|length }} fellow{{ 's' if cd.get('disaggregation',
                                [])|length != 1 }} — Click to view disaggregation details
                            </span>
                            <svg class="disagg-arrow w-5 h-5 text-slate-400 transition-transform duration-200"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Table (hidden by default) -->
                        <div class="hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-slate-50 border-b border-slate-200">
                                            <th
                                                class="px-6 py-4 text-left font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Fellow Name</th>
                                            <th
                                                class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Female</th>
                                            <th
                                                class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Rural</th>
                                            <th
                                                class="px-6 py-4 text-right font-bold text-slate-500 uppercase text-xs tracking-wider">
                                                Learner with Disability</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        {% for d in cd.get('disaggregation', []) %}
                                        <tr class="hover:bg-slate-50/50 transition">
                                            <td class="px-6 py-4 font-semibold text-slate-900">{{ d.name }}</td>
                                            <td class="px-6 py-4 text-right font-mono font-semibold text-pink-600">{{
                                                "{:,}".format(d.female) }}</td>
                                            <td class="px-6 py-4 text-right font-mono font-semibold text-amber-600">{{
                                                "{:,}".format(d.rural) }}</td>
                                            <td class="px-6 py-4 text-right font-mono font-semibold text-violet-600">{{
                                                "{:,}".format(d.disability) }}</td>
                                        </tr>
                                        {% endfor %}
                                        {% if not cd.get('disaggregation') %}
                                        <tr>
                                            <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">No
                                                disaggregation data available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            {% endfor %}

            <!-- ====== OVERALL TAB ====== -->
            <div id="tab-Overall" class="tab-panel" style="display:none">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-900">Program Overview</h2>
                    <p class="text-slate-500 mt-1">Cross-cohort comparison — live data from Airtable CRM</p>
                </div>

                <!-- Program KPI Cards -->
                {% set ov = kpis.Program_Overview %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                    <div
                        class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Sales (YTD)
                            </p>
                            <h4 class="text-2xl font-bold text-slate-800">R {{ "{:,.0f}".format(ov.Total_Sales_ZAR) }}
                            </h4>
                        </div>
                        <div class="w-11 h-11 rounded-full bg-blue-50 flex items-center justify-center text-injiniBlue">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div
                        class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Net Jobs Created
                            </p>
                            <h4 class="text-2xl font-bold text-slate-800">{{ ov.Net_Jobs_Created }}</h4>
                        </div>
                        <div
                            class="w-11 h-11 rounded-full bg-green-50 flex items-center justify-center text-injiniGreen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div
                        class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Median Sales
                                Growth</p>
                            {% set sg = ov['Average_Sales_Growth_%'] %}
                            <h4 class="text-2xl font-bold text-slate-800">{% if sg == "Insufficient Data" %}N/A{% else
                                %}{{ sg }}%{% endif %}</h4>
                        </div>
                        <div
                            class="w-11 h-11 rounded-full bg-yellow-50 flex items-center justify-center text-injiniGold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                    <div
                        class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Median Profit
                                Growth</p>
                            {% set pg = ov['Average_Profit_Growth_%'] %}
                            <h4 class="text-2xl font-bold text-slate-800">{% if pg == "Insufficient Data" %}N/A{% else
                                %}{{ pg }}%{% endif %}</h4>
                        </div>
                        <div
                            class="w-11 h-11 rounded-full bg-emerald-50 flex items-center justify-center text-injiniGreen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Cohort Comparison Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Sales Over Time (All
                            Cohorts)</h4>
                        <div id="overall-sales-chart" style="min-height: 320px;"></div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Profit Over Time (All
                            Cohorts)</h4>
                        <div id="overall-profit-chart" style="min-height: 320px;"></div>
                    </div>
                </div>

                <!-- Cohort Summary Cards -->
                <h3 class="text-lg font-bold text-slate-800 mb-4">Cohort Comparison</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                    {% for c in cohort_summaries %}
                    {% set c_sales = c['Total Sales'] %}
                    {% set c_profit = c['Total Profit'] %}
                    {% set c_jobs = c['Total Jobs'] %}
                    {% set c_learners = c['Total Learners'] %}
                    {% set c_msg = c['Median Sales Growth'] %}
                    {% set c_mpg = c['Median Profit Growth'] %}
                    <div class="bg-white rounded-xl p-6 border border-slate-100 shadow-sm">
                        <div class="flex items-center justify-between mb-5">
                            <h4 class="font-bold text-slate-900 text-lg">{{ c['Cohort'] }}</h4>
                            <span
                                class="text-xs font-bold px-3 py-1 bg-injiniBlue/10 text-injiniBlue rounded-full uppercase">{{
                                c['Ventures'] }} Ventures</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Total Sales</p>
                                <p class="text-lg font-bold text-slate-800">R {{ "{:,.0f}".format(c_sales) }}</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Total Profit</p>
                                <p
                                    class="text-lg font-bold {% if c_profit >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %}">
                                    R {{ "{:,.0f}".format(c_profit) }}</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Total Jobs</p>
                                <p class="text-lg font-bold text-slate-800">{{ "{:,.0f}".format(c_jobs) }}</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Jobs % Change</p>
                                {% set c_jpct = c['Jobs Pct Change'] %}
                                <p
                                    class="text-lg font-bold {% if c_jpct >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %}">
                                    {{ c_jpct }}%</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Subscribers</p>
                                <p class="text-lg font-bold text-injiniBlue">{{ "{:,.0f}".format(c_learners) }}</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Median Sales Growth
                                </p>
                                {% if c_msg == "Insufficient Data" %}
                                <p class="text-lg font-bold text-slate-400">N/A</p>
                                {% elif c_msg is number and c_msg < 0 %} <p class="text-lg font-bold text-injiniRed">{{
                                    c_msg }}%</p>
                                    {% else %}
                                    <p class="text-lg font-bold text-injiniGreen">{{ c_msg }}%</p>
                                    {% endif %}
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-[10px] text-slate-400 uppercase font-semibold mb-1">Median Profit Growth
                                </p>
                                {% if c_mpg == "Insufficient Data" %}
                                <p class="text-lg font-bold text-slate-400">N/A</p>
                                {% elif c_mpg is number and c_mpg < 0 %} <p class="text-lg font-bold text-injiniRed">{{
                                    c_mpg }}%</p>
                                    {% else %}
                                    <p class="text-lg font-bold text-injiniGreen">{{ c_mpg }}%</p>
                                    {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Jobs Summary -->
                {% set js = jobs_summary %}
                <h3 class="text-lg font-bold text-slate-800 mb-4">Program Jobs Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total Jobs</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">{{ "{:,}".format(js['Total Jobs']) }}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">New Jobs</p>
                        <p
                            class="text-2xl font-bold {% if js['New Jobs'] >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %} mt-1">
                            {{ "{:+,}".format(js['New Jobs']) }}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">% Change</p>
                        <p
                            class="text-2xl font-bold {% if js['Jobs Pct Change'] >= 0 %}text-injiniGreen{% else %}text-injiniRed{% endif %} mt-1">
                            {{ js['Jobs Pct Change'] }}%</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Female Jobs</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">{{ "{:,}".format(js['Female Jobs']) }}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Youth Jobs</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">{{ "{:,}".format(js['Youth Jobs']) }}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">New Female</p>
                        <p class="text-2xl font-bold text-injiniBlue mt-1">{{ "{:+,}".format(js['New Female Jobs']) }}
                        </p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">New Youth</p>
                        <p class="text-2xl font-bold text-injiniBlue mt-1">{{ "{:+,}".format(js['New Youth Jobs']) }}
                        </p>
                    </div>
                </div>

                <!-- Reach Summary -->
                {% set rs = reach_summary %}
                <h3 class="text-lg font-bold text-slate-800 mb-4">Program Reach</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-10">
                    <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total Subscribers</p>
                        <p class="text-3xl font-bold text-slate-800 mt-1">{{ "{:,}".format(rs['Total Subscribers']) }}
                        </p>
                    </div>
                    <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">New Subscribers</p>
                        <p class="text-3xl font-bold text-injiniGreen mt-1">{{ "{:,}".format(rs['New Subscribers']) }}
                        </p>
                    </div>
                    <div class="bg-white rounded-xl p-5 border border-slate-100 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total Schools</p>
                        <p class="text-3xl font-bold text-injiniBlue mt-1">{{ "{:,}".format(rs['Total Schools']) }}</p>
                    </div>
                </div>
            </div>

            <!-- AI CHAT FLOATING BUTTON -->
            <div class="fixed bottom-8 right-8 z-50">
                <button id="injini-ai-btn"
                    class="bg-white text-injiniBlue p-0 rounded-full shadow-2xl hover:scale-105 transition-transform duration-200 border-2 border-injiniGold w-16 h-16 flex items-center justify-center group overflow-hidden">
                    <img src="/static/logo.svg" alt="Injini AI" class="w-10 h-10 object-contain ml-1 mt-1"
                        style="filter: brightness(0) saturate(100%) invert(11%) sepia(95%) saturate(6157%) hue-rotate(234deg) brightness(73%) contrast(131%);">
                    <span class="absolute -top-2 -right-2 w-5 h-5 bg-injiniRed rounded-full animate-ping"></span>
                </button>
            </div>

            <!-- AI CHAT MODAL -->
            <div id="ai-chat-modal"
                class="fixed bottom-28 right-8 w-96 bg-white rounded-2xl shadow-2xl z-50 border border-slate-100 hidden flex flex-col overflow-hidden transition-all duration-300 transform scale-95 opacity-0 origin-bottom-right"
                style="height: 500px;">
                <div
                    class="bg-gradient-to-r from-injiniBlue to-blue-900 p-4 flex justify-between items-center text-white">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                            <img src="/static/logo.svg" class="w-5 h-5"
                                style="filter: brightness(0) saturate(100%) invert(11%) sepia(95%) saturate(6157%) hue-rotate(234deg) brightness(73%) contrast(131%);">
                        </div>
                        <div>
                            <h3 class="font-bold text-sm">Injini AI</h3>
                            <p class="text-[10px] text-blue-200 flex items-center gap-1"><span
                                    class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> Online</p>
                        </div>
                    </div>
                    <button id="close-chat" class="text-white/80 hover:text-white transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-4 text-sm">
                    <div class="flex gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-injiniGold/20 flex-shrink-0 flex items-center justify-center text-xs font-bold text-injiniBlue border border-injiniGold">
                            AI</div>
                        <div
                            class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-slate-700 border border-slate-100">
                            Welcome to Injini AI! I'm here to help you uncover insights and analyze your venture data.
                            What would you like to explore today? ✨
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-slate-100">
                    <form id="chat-form" class="relative">
                        <input type="text" id="chat-input" placeholder="Ask a question about the data..."
                            class="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-injiniBlue text-sm shadow-inner transition-all">
                        <button type="submit"
                            class="absolute right-2 top-2 p-1.5 bg-injiniBlue text-white rounded-lg hover:bg-blue-800 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- ====== JAVASCRIPT ====== -->
    <script>
        const tsData = {{ time_series_json | safe }};
        const cohortData = {{ cohort_detail_json | safe }};
        const cohortColors = { 'Cohort 1': '#001c94', 'Cohort 2': '#008a40', 'Cohort 3': '#ffd100', 'Cohort 4': '#ff585f' };
        const chartDefaults = { fontFamily: 'Montserrat', toolbar: { show: false } };
        const renderedCharts = {};

        // ─── LINEAR TREND HELPER ───
        function linearTrend(yValues) {
            const n = yValues.length;
            if (n < 2) return yValues;
            let sx = 0, sy = 0, sxy = 0, sx2 = 0;
            for (let i = 0; i < n; i++) { sx += i; sy += yValues[i]; sxy += i * yValues[i]; sx2 += i * i; }
            const slope = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
            const intercept = (sy - slope * sx) / n;
            return yValues.map((_, i) => Math.round(intercept + slope * i));
        }

        // ─── TAB SWITCHING ───
        function switchTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(el => el.style.display = 'none');
            const target = document.getElementById('tab-' + tabName);
            if (target) target.style.display = 'block';

            document.querySelectorAll('.sidebar-link').forEach(el => {
                const isActive = el.dataset.tab === tabName;
                el.className = 'sidebar-link w-full text-left block px-4 py-3 rounded-lg text-sm font-medium transition '
                    + (isActive ? 'bg-blue-800/50 border-l-4 border-injiniGold text-white' : 'text-blue-100 hover:bg-blue-800/50');
            });

            // Lazy-init charts after tab is visible
            setTimeout(() => {
                if (tabName === 'Overall') {
                    initOverallCharts();
                } else {
                    const cnum = { 'Cohort 1': 1, 'Cohort 2': 2, 'Cohort 3': 3, 'Cohort 4': 4 }[tabName];
                    if (cnum) initCohortCharts(tabName, cnum);
                }
            }, 50);
        }

        // ─── COHORT CHART INITIALIZATION ───
        function initCohortCharts(cohortKey, cnum) {
            if (renderedCharts[cohortKey]) return;
            const d = cohortData[cohortKey];
            if (!d) return;

            const lineOpts = (elId, series, title) => ({
                chart: { type: 'line', height: 310, ...chartDefaults },
                series: series,
                stroke: { width: 2.5, curve: 'smooth' },
                xaxis: { type: 'category', labels: { rotate: -45, style: { fontSize: '10px' } } },
                yaxis: { labels: { formatter: v => 'R ' + (v / 1000).toFixed(0) + 'k' } },
                tooltip: { y: { formatter: v => 'R ' + v.toLocaleString() } },
                legend: { position: 'top', fontSize: '11px' },
                grid: { borderColor: '#f1f5f9' },
            });

            // Sales line chart (per fellow + cohort aggregate + trend)
            if (d.fellows_sales && d.fellows_sales.length) {
                const series = d.fellows_sales.map(f => ({ name: f.name, data: f.data }));
                if (d.cohort_aggregate && d.cohort_aggregate.months.length) {
                    series.push({
                        name: 'Cohort Total',
                        data: d.cohort_aggregate.months.map((m, i) => ({ x: m, y: d.cohort_aggregate.sales[i] }))
                    });
                    // Trend line based on cohort aggregate
                    const trend = linearTrend(d.cohort_aggregate.sales);
                    series.push({
                        name: 'Sales Trend',
                        data: d.cohort_aggregate.months.map((m, i) => ({ x: m, y: trend[i] }))
                    });
                }
                const opts = lineOpts('sales', series, 'Sales');
                const n = series.length;
                opts.stroke = { width: series.map((_, i) => i >= n - 2 ? (i === n - 1 ? 2 : 3.5) : 2), curve: 'smooth', dashArray: series.map((_, i) => i >= n - 2 ? (i === n - 1 ? 8 : 5) : 0) };
                opts.colors = undefined; // let ApexCharts auto-assign, but make trend grey
                new ApexCharts(document.querySelector('#sales-c' + cnum), opts).render();
            }

            // Profit line chart (per fellow + cohort aggregate + trend)
            if (d.fellows_profit && d.fellows_profit.length) {
                const series = d.fellows_profit.map(f => ({ name: f.name, data: f.data }));
                if (d.cohort_aggregate && d.cohort_aggregate.months.length) {
                    series.push({
                        name: 'Cohort Total',
                        data: d.cohort_aggregate.months.map((m, i) => ({ x: m, y: d.cohort_aggregate.profit[i] }))
                    });
                    const trend = linearTrend(d.cohort_aggregate.profit);
                    series.push({
                        name: 'Profit Trend',
                        data: d.cohort_aggregate.months.map((m, i) => ({ x: m, y: trend[i] }))
                    });
                }
                const opts = lineOpts('profit', series, 'Profit');
                const n = series.length;
                opts.stroke = { width: series.map((_, i) => i >= n - 2 ? (i === n - 1 ? 2 : 3.5) : 2), curve: 'smooth', dashArray: series.map((_, i) => i >= n - 2 ? (i === n - 1 ? 8 : 5) : 0) };
                new ApexCharts(document.querySelector('#profit-c' + cnum), opts).render();
            }

            // Jobs clustered bar chart
            if (d.jobs_bar && d.jobs_bar.months.length) {
                new ApexCharts(document.querySelector('#jobs-c' + cnum), {
                    chart: { type: 'bar', height: 310, ...chartDefaults },
                    series: [
                        { name: 'Total Jobs', data: d.jobs_bar.total },
                        { name: 'Female Jobs', data: d.jobs_bar.female },
                        { name: 'Youth Jobs', data: d.jobs_bar.youth },
                    ],
                    colors: ['#001c94', '#ec4899', '#ffd100'],
                    plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
                    xaxis: { categories: d.jobs_bar.months, labels: { rotate: -45, style: { fontSize: '10px' } } },
                    yaxis: { labels: { formatter: v => v.toLocaleString() } },
                    legend: { position: 'top', fontSize: '11px' },
                    grid: { borderColor: '#f1f5f9' },
                }).render();
            }

            // Total Subscribers chart
            if (d.reach && d.reach.months.length) {
                new ApexCharts(document.querySelector('#subs-c' + cnum), {
                    chart: { type: 'line', height: 290, ...chartDefaults },
                    series: [
                        { name: 'Total Learners', data: d.reach.total_learners },
                        { name: 'Total Educators', data: d.reach.total_educators },
                    ],
                    colors: ['#001c94', '#008a40'],
                    stroke: { width: 2.5, curve: 'smooth' },
                    xaxis: { categories: d.reach.months, labels: { rotate: -45, style: { fontSize: '10px' } } },
                    yaxis: { labels: { formatter: v => v.toLocaleString() } },
                    legend: { position: 'top', fontSize: '11px' },
                    grid: { borderColor: '#f1f5f9' },
                }).render();

                // New Subscribers cumulative chart
                new ApexCharts(document.querySelector('#newsubs-c' + cnum), {
                    chart: { type: 'area', height: 290, ...chartDefaults },
                    series: [
                        { name: 'New Learners (Cumulative)', data: d.reach.new_learners_cum },
                        { name: 'New Educators (Cumulative)', data: d.reach.new_educators_cum },
                    ],
                    colors: ['#001c94', '#008a40'],
                    stroke: { width: 2, curve: 'smooth' },
                    fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.1 } },
                    xaxis: { categories: d.reach.months, labels: { rotate: -45, style: { fontSize: '10px' } } },
                    yaxis: { labels: { formatter: v => v.toLocaleString() } },
                    legend: { position: 'top', fontSize: '11px' },
                    grid: { borderColor: '#f1f5f9' },
                }).render();

                // Schools chart
                new ApexCharts(document.querySelector('#schools-c' + cnum), {
                    chart: { type: 'line', height: 290, ...chartDefaults },
                    series: [
                        { name: 'South African Schools', data: d.reach.sa_schools },
                        { name: 'Q1-3 Schools', data: d.reach.q13_schools },
                    ],
                    colors: ['#001c94', '#ffd100'],
                    stroke: { width: 2.5, curve: 'smooth' },
                    markers: { size: 4 },
                    xaxis: { categories: d.reach.months, labels: { rotate: -45, style: { fontSize: '10px' } } },
                    yaxis: { labels: { formatter: v => v.toLocaleString() } },
                    legend: { position: 'top', fontSize: '11px' },
                    grid: { borderColor: '#f1f5f9' },
                }).render();
            }

            renderedCharts[cohortKey] = true;
        }

        // ─── OVERALL CHARTS ───
        function initOverallCharts() {
            if (renderedCharts['Overall']) return;

            // Sales comparison chart (numbered months)
            const salesSeries = [];
            for (const [cohort, data] of Object.entries(tsData.cohort || {})) {
                salesSeries.push({ name: cohort, data: data.sales.map((v, i) => ({ x: 'Month ' + (i + 1), y: Math.round(v) })) });
            }
            if (tsData.program && tsData.program.months.length) {
                salesSeries.push({ name: 'Program Total', data: tsData.program.sales.map((v, i) => ({ x: 'Month ' + (i + 1), y: Math.round(v) })) });
                // Program trend line
                const trend = linearTrend(tsData.program.sales.map(v => Math.round(v)));
                salesSeries.push({ name: 'Program Trend', data: trend.map((v, i) => ({ x: 'Month ' + (i + 1), y: v })) });
            }
            const sn = salesSeries.length;
            new ApexCharts(document.querySelector('#overall-sales-chart'), {
                chart: { type: 'line', height: 310, ...chartDefaults },
                series: salesSeries,
                colors: Object.values(cohortColors).concat(['#374151', '#9ca3af']),
                stroke: { width: salesSeries.map((_, i) => i === sn - 1 ? 2 : 2.5), curve: 'smooth', dashArray: salesSeries.map((_, i) => i === sn - 1 ? 8 : 0) },
                xaxis: { type: 'category', labels: { rotate: -45, style: { fontSize: '10px' } } },
                yaxis: { labels: { formatter: v => 'R ' + (v / 1000).toFixed(0) + 'k' } },
                tooltip: { y: { formatter: v => 'R ' + v.toLocaleString() } },
                legend: { position: 'top', fontSize: '11px' },
                grid: { borderColor: '#f1f5f9' },
            }).render();

            // Profit comparison chart (numbered months)
            const profitSeries = [];
            for (const [cohort, data] of Object.entries(tsData.cohort || {})) {
                profitSeries.push({ name: cohort, data: data.profit.map((v, i) => ({ x: 'Month ' + (i + 1), y: Math.round(v) })) });
            }
            if (tsData.program && tsData.program.months.length) {
                profitSeries.push({ name: 'Program Total', data: tsData.program.profit.map((v, i) => ({ x: 'Month ' + (i + 1), y: Math.round(v) })) });
                const trend = linearTrend(tsData.program.profit.map(v => Math.round(v)));
                profitSeries.push({ name: 'Program Trend', data: trend.map((v, i) => ({ x: 'Month ' + (i + 1), y: v })) });
            }
            const pn = profitSeries.length;
            new ApexCharts(document.querySelector('#overall-profit-chart'), {
                chart: { type: 'line', height: 310, ...chartDefaults },
                series: profitSeries,
                colors: Object.values(cohortColors).concat(['#374151', '#9ca3af']),
                stroke: { width: profitSeries.map((_, i) => i === pn - 1 ? 2 : 2.5), curve: 'smooth', dashArray: profitSeries.map((_, i) => i === pn - 1 ? 8 : 0) },
                xaxis: { type: 'category', labels: { rotate: -45, style: { fontSize: '10px' } } },
                yaxis: { labels: { formatter: v => 'R ' + (v / 1000).toFixed(0) + 'k' } },
                tooltip: { y: { formatter: v => 'R ' + v.toLocaleString() } },
                legend: { position: 'top', fontSize: '11px' },
                grid: { borderColor: '#f1f5f9' },
            }).render();

            renderedCharts['Overall'] = true;
        }

        // ─── INITIALIZE FIRST TAB ───
        initCohortCharts('Cohort 1', 1);

        // ─── AI CHAT LOGIC ───
        const chatBtn = document.getElementById('injini-ai-btn');
        const chatModal = document.getElementById('ai-chat-modal');
        const closeChat = document.getElementById('close-chat');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        function toggleChat() {
            if (chatModal.classList.contains('hidden')) {
                chatModal.classList.remove('hidden');
                setTimeout(() => {
                    chatModal.classList.remove('opacity-0', 'scale-95');
                    chatInput.focus();
                }, 10);
            } else {
                chatModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => { chatModal.classList.add('hidden'); }, 300);
            }
        }
        chatBtn.addEventListener('click', toggleChat);
        closeChat.addEventListener('click', toggleChat);

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 ' + (isUser ? 'flex-row-reverse' : '');
            const avatar = isUser
                ? `<div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-xs font-bold text-slate-500">YOU</div>`
                : `<div class="w-8 h-8 rounded-full bg-injiniGold/20 flex-shrink-0 flex items-center justify-center text-xs font-bold text-injiniBlue border border-injiniGold">AI</div>`;
            const bubble = `<div class="${isUser ? 'bg-injiniBlue text-white' : 'bg-white text-slate-700 border border-slate-100'} p-3 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm max-w-[80%]">${text}</div>`;
            div.innerHTML = avatar + bubble;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (!msg) return;
            addMessage(msg, true);
            chatInput.value = '';
            chatInput.disabled = true;

            const typingId = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex gap-3';
            typingDiv.id = typingId;
            typingDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-injiniGold/20 flex-shrink-0 flex items-center justify-center text-xs font-bold text-injiniBlue border border-injiniGold">AI</div>
            <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-slate-500 border border-slate-100 italic">Thinking...</div>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                document.getElementById(typingId).remove();
                const formatted = data.response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                addMessage(formatted, false);
            } catch (err) {
                document.getElementById(typingId).remove();
                addMessage("Sorry, I'm having trouble connecting to the server.", false);
            } finally {
                chatInput.disabled = false;
                chatInput.focus();
            }
        });
    </script>
</body>

</html>